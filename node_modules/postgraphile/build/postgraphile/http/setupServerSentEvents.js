"use strict";
function setupServerSentEvents(req, res, options) {
    const { _emitter } = options;
    // Making sure these options are set.
    req.socket.setTimeout(0);
    req.socket.setNoDelay(true);
    req.socket.setKeepAlive(true);
    // Set headers for Server-Sent Events.
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
    });
    const sse = str => {
        res.write(str);
        // support running within the compression middleware.
        // https://github.com/expressjs/compression#server-sent-events
        if (res.flushHeaders)
            res.flushHeaders();
    };
    // Notify client that connection is open.
    sse('event: open\n\n');
    // Setup listeners.
    const schemaChangedCb = () => sse('event: change\ndata: schema\n\n');
    if (options.watchPg)
        _emitter.on('schemas:changed', schemaChangedCb);
    // Clean up when connection closes.
    req.on('close', () => {
        res.end();
        _emitter.removeListener('schemas:changed', schemaChangedCb);
    });
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = setupServerSentEvents;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXBTZXJ2ZXJTZW50RXZlbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3Bvc3RncmFwaGlsZS9odHRwL3NldHVwU2VydmVyU2VudEV2ZW50cy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsK0JBQStDLEdBQUcsRUFBRSxHQUFHLEVBQUUsT0FBTztJQUM5RCxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsT0FBTyxDQUFBO0lBRTVCLHFDQUFxQztJQUNyQyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN4QixHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUMzQixHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUU3QixzQ0FBc0M7SUFDdEMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDakIsY0FBYyxFQUFFLG1CQUFtQjtRQUNuQyxlQUFlLEVBQUUsVUFBVTtRQUMzQixZQUFZLEVBQUUsWUFBWTtLQUMzQixDQUFDLENBQUE7SUFFRixNQUFNLEdBQUcsR0FBRyxHQUFHO1FBQ2IsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUVkLHFEQUFxRDtRQUNyRCw4REFBOEQ7UUFDOUQsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztZQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQTtJQUMxQyxDQUFDLENBQUE7SUFFRCx5Q0FBeUM7SUFDekMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUE7SUFFdEIsbUJBQW1CO0lBQ25CLE1BQU0sZUFBZSxHQUFHLE1BQU0sR0FBRyxDQUFDLGlDQUFpQyxDQUFDLENBQUE7SUFFcEUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztRQUNsQixRQUFRLENBQUMsRUFBRSxDQUFDLGlCQUFpQixFQUFFLGVBQWUsQ0FBQyxDQUFBO0lBRWpELG1DQUFtQztJQUNuQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRTtRQUNkLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtRQUNULFFBQVEsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLEVBQUUsZUFBZSxDQUFDLENBQUE7SUFDN0QsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDOztBQXJDRCx3Q0FxQ0MifQ==